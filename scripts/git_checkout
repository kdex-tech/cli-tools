#!/bin/sh

set -e

cd "${WORKDIR}"

# 1. Clone the repo
REPOSITORY=$(durl +%S${GIT_USERNAME}:${GIT_PASSWORD}@%H%p ${GIT_HOST})
git clone "${REPOSITORY}/${GIT_ORG}/${GIT_REPO}" .

# 2. Basic Git Identity (No Signing)
git config user.email "${COMMITTER_EMAIL}"
git config user.name "${COMMITTER_NAME}"
# Explicitly disable signing to avoid errors if the runner has global defaults
git config commit.gpgsign false

# 3. Sanitize variables to create a safe branch name
BRANCH_NAME="gen/${FUNCTION_HOST}/${FUNCTION_NAME}"

# 4. Check if branch exists on remote, then switch or create
if git ls-remote --heads origin "${BRANCH_NAME}" | grep -q "${BRANCH_NAME}"; then
  git fetch origin "${BRANCH_NAME}"
  git checkout "${BRANCH_NAME}"
else
  git checkout -b "${BRANCH_NAME}"
fi

# 5. Create the subdirectory if it doesn't exist
# We target the specific subdirectory for this function
TARGET_DIR="${COMMIT_SUB_DIRECTORY}/${FUNCTION_HOST}/${FUNCTION_NAME}"
mkdir -p "${TARGET_DIR}"

# 6. Ignore the .env file
grep -q ".env" .gitignore 2>/dev/null || echo ".env" >> .gitignore

# 7. Add details to the .env file
echo "TARGET_DIR=${TARGET_DIR}" > .env
echo "BRANCH_NAME=${BRANCH_NAME}" >> .env